---
title: 关系代数和SQL
date: 2021-05-19 15:33:02
permalink: /courses/database/sql
categories:
  - 课程学习
  - 数据库系统原理
tags: 
  - SQL
  - DataBase
  - Backend
---

# 关系代数与SQL

## 关系完整性

- 实体完整性规则: 主属性非空
- 参照完整性: 外码空值或为另一个表中的主码的值
- 用户自定义完整性: (回头写)

## 关系代数

### 选择

选择为从关系模式中选出一个元组，也就是选出一行作为结果，可以选择是否添加条件。(选择是选择所有的元组或者满足其中一个条件的元组)

$\sigma(R)$表示选择所有元组, $\sigma_F(R)$表示选择满足条件F的所有元组。等价的SQL语句为:

```sql
select * from R;
select * from R where F;
```

### 投影

投影为选择哪些列作为输出结果。也就是会选出所有的对应列。

$\Pi_{a,b,c}(R)$表示选择a,b,c列的所有元素。等价SQL语句为:

```sql
select a, b, c from R;
```

当选择和投影组合使用($\Pi_{a,b,c}(\sigma_F(R))$)时等价于:
```sql
select a, b, c from R where F;
```

### 并

:::tip
两个关系模式必须同构，跟传统集合运算相关的都要求操作数同构才能进行运算
:::

将关系模式看成一个集合，集合里面的元素就是一个一个元组，也就是一行一行，两个关系模式取并集表示将两个关系模式所有的元素都放到同一个关系模式下。$\sigma_F(R_1)\cup \sigma_F(R_2)$

等价SQL语句:

```sql
select * from R1 where F;
intersect
select * from R2 where F;
```

### 差

将关系模式看成一个集合，集合里面的元素就是元组，跟传统集合相减相同。$\sigma_F(R_1) - \sigma_F(R_2)$

```sql
select * from R1 where F;
except
select * from R2 where F;
```

### 笛卡尔积

与集合笛卡尔积类似，把元组当作操作的元素即可。笛卡尔积的连接一般无物理意义，所以需要通过条件来约束。

```sql
select * from R, S where R.B=S.B;
```

### 连接

- 自然连接

自然连接是等值连接的一种，通常是将两个表中某一个属性相等的值所在的两个元组拼接成一个元组。有重复的列就合并成一个。$R\bowtie S$

- 左外连接

保证最后结果表的左边是非空，所有的空值都在右边。在自然连接的基础上补上左集合中没有的列。没有对应值的项补null

- 右外连接

保证最后结果表的右边是非空，所有的空值都在左边。在自然连接的基础上补上右集合中没有的列。没有对应值的项补null

### 交

将关系模式看成一个集合，集合里面的元素就是一个一个元组，也就是一行一行，两个关系模式取交集表示将两个关系模式共有的元素都放到同一个关系模式下。$\sigma_F(R_1)\cap \sigma_F(R_2)$

```sql
select * from R where F;
union
select * from S where F;
```
### 除

Y除掉相同的列，留下的X中包含Y的所有元组的元组，留下被除数。关系代数表示$R\div S$

运算步骤:两个关系模式中相同的列删掉，只留下被除数R剩下的列A，然后在被删掉的列中找R与S值相同的元组，然后将对应列A的值加入到剩下的列A.

除法一般可以解决至少相关的问题，因为除法求解的就是包含关系

例子:
若有一个学生-课程数据库，查询至少选修1号课程和3号课程的学生的学号。则先建立一个临时的关系K，K的属性是Cno，有两个元组1和3，然后使用除法$\Pi_{Sno,Cno}(SC)\div K$

### 去重

表示去掉元素值相同的元组，关系代数表示为$\delta(R)$

```sql
select distinct a from R where F;
```

### 重命名

表示将关系模式的属性重命名，关系代数表示为$\rho_{S_1,S_2,...}(A,B,C...)(R)$

重命名的目的是为了使得两个关系模式同构，能够进行关系代数运算，临时改变属性的名字，但是最终不会改变。

### 排序

表示关系模式按照某一个属性从小到大或者从大到小进行排序。关系代数表示为:$\tau_L(R)$表示含义是在关系模式R中以L进行排序.

```sql
select * from R order by asc L; --升序
select * from R order by desc L; --降序
```

### 分组

分组是使得具有相同值的分在同一组，比如说按照L属性分组，关系代数表示:$\gamma_{L,fun}(R)$，其中fun为聚类函数。

按照分组字段，将获取到的记录分为几块，保留每块的第一条记录。

group by 主要实现**分组统计**，分组统计主要要用到以下的聚类函数。

```sql
select L, fun, from R group by L;
```

常用的聚类函数有:

- count(*/字段名)： 统计分组字段对应的记录数量
- max(*/字段名)：统计分组后某个字段的最大值
- min(*/字段名)：统计分组后某个字段的最小值
- avg(*/字段名)：统计分组后某个字段的平均值
- sum(*/字段名)：统计分组后某个字段的和

## SQL

- 条件where，python用法类似，基于表或视图，选中满足条件的组
- 去重distinct:去除掉元组中重复元素
- 子句having:having作用于组，选中满足条件的组，对group by分组结果进行筛选。
- order by:按照某一个属性进行排序
- group by:按照某一个属性进行分组
- exists:判断是否查询到数据(子查询)，不会返回数据，只会产生true/false两值


### 视图

视图是指一个虚表，实际不会存储任何元组元素的表，是由一个或者多个基本的表生成的具有不同属性的虚表。数据库会通过视图来找到存储在原表中的数据。创建视图是通过子查询语句创建，所运行的子查询语句就是视图所包含的属性也就是表头。

```sql
create view view_1 as 
  select sno, sname ,asage from student where sdept='is';
```

